function [Y,Xf,Af] = fftNN3(X,~,~)
%FFTNN3 neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 21-Mar-2017 19:06:46.
% 
% [Y] = fftNN3(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timsteps
%   Each X{1,ts} = 17xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 3xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

  % ===== NEURAL NETWORK CONSTANTS =====
  
  % Input 1
  x1_step1_xoffset = [-0.917103384641671;-0.639802503070802;-0.388031701214615;-0.284465134007495;-0.214711012175;-37.2950087569508;-41.1833511777846;-42.7724402998151;-46.3625140718605;-35.492114133793;-0.0017533024176725;-0.00252560647761772;-0.00186031962758274;-0.00307140241991538;-0.00273091370327986;-0.00271502818432267;-0.00243932712535547];
  x1_step1_gain = [1.20879926971722;1.68119547897107;2.70704799528997;3.7560963238931;4.98788595677787;0.014922464321307;0.0182040603470884;0.0207459644653692;0.022576535499204;0.0273889958877321;349.485107369648;480.842023309575;475.739540361778;357.628905246286;406.236331669828;413.244185433512;422.148744042079];
  x1_step1_ymin = -1;
  
  % Layer 1
  b1 = [1.3946849894945838599;1.4611717322103436878;1.2446997592685062894;1.2436019505691717768;0.8907583432105065091;-0.87676097296183208574;0.67389585237911575621;-1.2559058307724211279;-0.18776924262233227192;0.17230099521054201284;-0.0073146433720070735962;-0.29790753267172420671;0.42665729945284974756;0.34317652086087468977;0.88312271296183209035;-0.89775446020153792936;-1.201193082810071644;-1.0452949532584032699;1.4096406609379354968;1.4240455857324783029];
  IW1_1 = [-0.39032746476821700288 -0.26209623242081792061 -0.41503331161762513357 -0.095851027662729654244 0.020302705824815428515 -0.36728314859762711819 0.68402826160448992887 0.17776648937048267207 -0.00068940521589127179598 -0.52005611333069690083 0.84110939806446027855 0.14199167309549065585 0.85399380356400667047 -0.1884352616988592688 -0.4108022144914485474 -0.90879097218342785869 -0.25864668179893146593;-0.088892668422559384389 0.18440921640985796781 -0.015384639645436052127 -0.26690460395519366443 0.071082772075088576647 0.66118292877576201327 0.34223467579092681223 -0.40932494194995405756 -0.37008294836243776915 0.032898312569595064558 0.12807477828827804056 -0.33855679557140866409 -0.0063163591385227441793 -0.52734380727740348682 -0.14157399488843036561 0.19404053221324696343 0.032066363779951971569;-0.78566607739641236563 0.23754905751065211184 -0.11471535576302682724 -0.64402224479743241936 0.42303015629562046307 -0.39581197780652105367 0.056106380333420448336 -0.51841757540191946152 -0.37369364431487639422 -0.073847575655558578278 -0.351680700497358667 0.37983237830174071403 0.34295998740230365653 0.28339934677947525854 0.029244865751878661858 0.28121106044920274325 0.13527337048447352075;0.10413297765333141831 0.21363754437618603932 -0.22206141479508889613 -0.34962656272448466854 -0.32636197321711546415 -0.42026208376670415312 -0.30275172636365110801 -0.5313193383200973674 -0.28930757398086814902 0.27223788535928422627 -0.54453046666297244549 0.22864100440343623766 0.082170993312555049015 -0.43172852118111232356 -0.36768185579965095844 -0.089296034752239114574 -0.040837853364848096527;-0.49546722268509640896 -0.17431378510063191833 0.33750250022094024915 -0.58211222046862498569 -0.13748542892910958768 -0.1179052933265338915 -0.39496879403885798432 0.054463866088998981463 0.47957087387759378405 0.61538548882261678852 0.68219524414066967655 -0.081011412252908920895 0.40743345068646713569 -0.675552599134626508 0.34561418064032284336 -0.2688903536564180019 0.23809654255450396487;0.25449699718805840476 -0.10459794126673641057 0.33176071303132870227 0.26546595922772686649 -0.21516968403746530858 -0.084178444381340811198 -0.34207599310191599828 0.29680349372766035021 0.38033791566578134535 -0.16789292560565619028 -0.48123149329040837419 -0.23348106684738498262 0.63320998492210822661 -0.48650580369126339431 0.24646844806114562298 -0.28058259136848495707 0.23680336276831845388;-0.4287483315979491727 0.43923041368919429894 -0.28145453158897881796 -0.46666288431906277623 0.092714600958681808729 0.072968380725356968286 0.5886265630092051282 0.48577350078767417285 -0.46686782678709332073 0.41400113223013829122 -0.34824960406558902459 0.08715501204408684921 0.30251019658866734607 0.48568808714037831065 -0.28021071237144912214 0.49977008820791107846 -0.30280008581176937055;0.39153966887424085375 -0.77221726152075198524 -0.10570528881430761581 -0.081270473300948581352 -0.26537332449728467942 0.69374585783227948887 -0.095142526188480749938 0.34565219742872566044 0.67753161556988505954 -0.1351334183113909182 0.38199177827145425201 -0.78489017490268819799 -0.01859373662848977371 -0.50260912155263137713 -0.63749885213999113454 -0.54303655049415133771 -0.60459609548010817548;0.51606254395021000647 0.40792339337517941056 -0.33864683371517184662 0.38858962458776125093 -0.21063547303237881159 -0.18577266279515744496 -0.39835924504267650192 -0.58125426526785373138 0.32236694610718868992 0.47785900127582403574 0.14715593914010205445 0.24144471801721914539 -0.26352967115648662233 -0.22153690834522463127 0.40978473460776376758 0.63748181735652975632 0.56021536321801235214;-0.62047799184055218991 0.66702523433358806848 0.55717170250173009283 0.36486715675991088226 0.61782902967656228022 -0.13913241075424678805 -0.36307653548110352393 -0.083643116184204294172 0.33568745148788464716 0.46331148917041642399 -0.21126470965067706276 0.13839397253287608058 0.71836641446589066806 -0.0044538091454509659214 -0.024240781395670138454 -0.027446862975520475852 0.088063827932026841894;0.096633928097383775535 0.47568210553258483131 0.025526299306530761402 0.44775147787113434017 -0.1042576144393276838 -0.53756189663479259089 -0.5721130734938238982 -0.10321638708706855347 -0.57845574331614391106 0.86295878840358997142 -0.0017101222304651913196 -0.13572624832172244802 0.060527568099370543386 -0.68482347726540282462 0.34554330408434436039 0.14017812034863605386 -0.22692075618866203168;-0.41806796838147641804 -0.2304882948947371557 0.37741259152267930821 0.066713886653270867977 -0.082343463227239441227 -0.39326064977167995984 -0.35006402506497719118 0.058202136133060619616 0.64583559526631140191 0.63669021463188679721 -0.16412802650003147087 0.34357838789064520935 -0.45878993127722184076 -0.01555632323473231382 -0.62438524401372752504 -0.62600702471041724806 0.24074342577643964569;0.42456985710349737229 -0.20854611636615416614 0.053211818427338131166 -0.011084682383648984325 -0.51266887387461634873 0.57203263100432066857 0.25136209442900225852 0.23533367963393475586 -0.71669934624871201034 0.47588427179952907942 -0.71925028474276964108 -0.69187635087412657775 0.063978998502837142182 -0.97096551204786785139 -0.52851277851024824894 -0.69215140061308488839 -0.33596610132923493408;0.39686094920116832263 -0.35912247720353634994 0.0070105126921041959961 -0.083427993593018112684 -0.6383365053280202206 -0.17221940984611963654 -0.23499642972477224889 0.49315783450359890194 -0.51080406502429320792 -0.54070314242330941301 -0.072928923658721070411 0.17396901970483719113 -0.38506542989267045218 -0.06518670270287175994 -0.12836219518525049388 -0.4029038525340859489 -0.74822468988435730797;0.14657853410963525564 0.54890310168900235954 0.14117055809949591305 0.52757078560501557973 -0.27081875001772232059 0.17178380079800692481 -0.47792754780288615457 -0.33333373631148144334 -0.58360027301180128489 0.26717132608317994968 -0.20541892472202602504 -0.42941658454686776336 0.24322272600703212508 0.0074134873602166098672 0.57661942695788215296 0.53574682632206349631 0.15061167463525332311;-0.3509152921571335737 0.1844722962675323652 0.7371213456134858566 0.46375911940479203066 0.37271624974088624072 -0.39522046908874158833 0.22015965957213309845 -0.62823515111850780634 0.52491917890730566132 0.097220941391360685135 0.25443077356308418935 0.053309046460148647173 0.31174902939229837129 -0.26576283432497660453 0.14272691266988971059 0.31016952360791638643 0.63899899956693784198;-0.46528507595368950867 -0.13257927259246590768 0.45815529782362524047 -0.23178390911106452887 0.57775314090863649774 -0.094600790889958194518 0.19995086008991702631 -0.49036895648859019081 0.41251405900812021521 0.19702655610846514511 -0.24128326137872324608 0.08138652233073358222 0.51661908542189349802 0.35906643787668057755 0.17194957822335732445 0.64680207989781413058 0.19240872972688380371;0.18728361236314447491 0.62128863474694551172 -0.22753779044837194045 0.99279435415544525778 0.088365040893920027143 -0.25427461182079058588 -0.59106029386429315142 -0.49523872648001621144 0.0014443056868698863834 0.062035189281101014991 -0.60492325282686454369 0.73608492015315940549 -0.78107870012713442875 -0.032011250732844075129 -0.17936572376087653313 1.0833601080251760163 0.22733310664780639887;0.24426367349768146608 0.54169162309597806981 -0.50168589186709433569 -0.10893536156962584094 -0.18818796274904145416 0.59783666302069249365 -0.054001562928772277317 -0.41345515845344471551 -0.15377663297518912033 -0.10017944381112361962 0.11158571446813961292 0.13089903133350905273 -0.14559625899625402989 -0.39971363489446409822 -0.48194433579666307033 -0.36596665873640082944 0.78807520656785168267;0.50393387095185637747 -0.38040412761124470231 -0.85349535644278273772 -0.822607330246696411 -0.19404245802988356884 0.64490026580099768516 -0.15509534438460034766 0.17527461580061687307 0.13664080408252077259 -0.1572844086402823971 0.12674169426553102968 -0.5950027239833820536 -0.27587333621716020327 -0.3714784806057987443 -0.32935602015236981055 -0.36141565044191187317 -0.57807608227663742628];
  
  % Layer 2
  b2 = [-0.10892113467914391056;0.21116066345522813141;-0.28252240225684771557];
  LW2_1 = [0.62793409465251759372 0.098969489702962085143 -0.41787614362992497874 0.11650868467919743565 0.13220505606733654047 0.53790085407467724821 0.13614948135704318943 -0.26006122889834887291 -0.37541970346227943045 0.057548228211460508708 -0.25953462474669275473 0.59123059725893500893 0.74792303701046536357 -0.3063656429698933259 -0.52952413359375727353 -0.27031751152392330395 -0.50285856088974023592 -0.22860020778388850937 0.025858291586501269688 0.076712053743728733646;0.80303917503232258301 0.87724675149004638364 0.63585930392197576033 -1.0284065831405724278 0.074088316619969632471 0.89785674112274194147 -0.15670739736850447521 0.44620090262406847392 -0.23815600447557852548 -0.079230495583332546938 0.41343131448089776026 0.78452529288718042544 0.4629350598253347826 0.05991364599715284095 -0.69507132300217577825 -0.21077896790163999641 0.11608869919865358322 -0.26650975614274330372 0.38543729578635460564 0.35022314869308801555;0.95513827928512651244 -0.37449780909936897233 -0.34139694448968954665 0.41693316045676304116 -0.016600755036655878011 -0.95074192426939363454 0.22076386699004146852 0.26519282714963215986 0.52669139018090160853 0.32617537056542161844 -0.59126321115816282692 0.57928448576519531166 1.0754716631342968736 0.15873053243445911509 -0.34634495129285253201 0.85832293238758727849 -0.68324575153497468794 -0.59338509247639359412 -0.63473259354827260559 0.31462965961680405824];
  
  % ===== SIMULATION ========
  
  % Format Input Arguments
  isCellX = iscell(X);
  if ~isCellX, X = {X}; end;
  
  % Dimensions
  TS = size(X,2); % timesteps
  if ~isempty(X)
    Q = size(X{1},2); % samples/series
  else
    Q = 0;
  end
  
  % Allocate Outputs
  Y = cell(1,TS);
  
  % Time loop
  for ts=1:TS
  
    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
  end
  
  % Final Delay States
  Xf = cell(1,0);
  Af = cell(2,0);
  
  % Format Output Arguments
  if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
  y = bsxfun(@minus,x,settings_xoffset);
  y = bsxfun(@times,y,settings_gain);
  y = bsxfun(@plus,y,settings_ymin);
end

% Competitive Soft Transfer Function
function a = softmax_apply(n)
  nmax = max(n,[],1);
  n = bsxfun(@minus,n,nmax);
  numer = exp(n);
  denom = sum(numer,1); 
  denom(denom == 0) = 1;
  a = bsxfun(@rdivide,numer,denom);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end
